<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Artists Donations</title>
    <meta name="description" content="Donations from Chinese mainland artists and celebrities for Tai Po fire relief">
    <meta property="og:title" content="Chinese Artists Donations">
    <meta property="og:description" content="Donations from Chinese mainland artists and celebrities for Tai Po fire relief">
    <meta property="og:image" content="https://taipo-big-donations-watcher.github.io/og-image-en.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://taipo-big-donations-watcher.github.io/og-image-en.png">
    <link rel="icon" type="image/png" href="../../favicon.png">
    <link rel="alternate" hreflang="en" href="https://taipo-big-donations-watcher.github.io/en/">
    <link rel="alternate" hreflang="zh-Hant" href="https://taipo-big-donations-watcher.github.io/zh/">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #2d3436;
            --heading-color: #1e272e;
            --accent-color: #2c3e50; /* Somber Navy */
            --border-color: #dfe6e9;
            --card-bg: #ffffff;
            --muted-text: #636e72;
            --highlight-bg: #f1f2f6;
            
            /* Badge Colors */
            --badge-bg: #e5e5e5;
            --badge-text: #000000;
            
            /* Type Colors (Pastel with Black Text) */
            --color-corp: #eecbc7; 
            --color-indv: #a0f4fa; 
            --color-org: #aee7a7;
            --color-celeb: #e6a7e7; 
            --text-contrast: #000000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: var(--text-color);
            background: var(--bg-color);
        }

        /* Header & Navigation */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--heading-color);
            font-weight: 700;
        }

        /* Navigation Menu */
        .nav-menu {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95em;
        }

        .nav-link:hover {
            color: var(--accent-color);
        }

        .lang-switch {
            padding: 6px 12px;
            background: transparent;
            color: var(--accent-color);
            text-decoration: none;
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .lang-switch:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Burger Menu (Mobile) */
        .burger-menu {
            display: none;
            font-size: 1.5em;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--heading-color);
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
                width: 100%;
                flex-direction: column;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #eee;
                margin-top: 15px;
            }

            .nav-menu.active {
                display: flex;
            }

            .burger-menu {
                display: block;
            }
            
            header {
                padding-bottom: 15px; /* Adjust for collapsed state */
            }
        }

        /* Header Badges */
        .header-badges {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75em;
            font-weight: 500;
            text-decoration: none;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .badge-label {
            background: #555;
            color: #fff;
            padding: 4px 8px;
        }
        
        .badge-value {
            background: #007ec6;
            color: #fff;
            padding: 4px 8px;
        }
        
        .badge-value.green {
            background: #28a745;
        }
        
        /* Intro Section */
        .intro {
            margin-bottom: 25px;
        }
        
        .intro-subtitle {
            color: var(--muted-text);
            font-size: 0.95em;
            line-height: 1.7;
            margin: 15px 0;
        }
        
        .intro hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }
        
        .summary-text {
            font-size: 1.15em;
            color: var(--heading-color);
            margin: 0;
            line-height: 1.5;
        }
        
        .summary-text strong {
            color: var(--accent-color);
        }

        /* Controls Section */
        .controls {
            margin-bottom: 25px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .search-btn:hover, .search-btn.active {
            background: var(--highlight-bg);
            border-color: var(--accent-color);
        }

        .search-input-wrapper {
            position: absolute;
            left: 0;
            top: 0;
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 10;
            background: var(--card-bg);
            border-radius: 8px;
        }

        .search-input-wrapper.active {
            width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 40px; /* Space for icon */
            font-size: 0.95em;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            outline: none;
        }
        
        /* Search icon inside input when active */
        .search-input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            opacity: 0.5;
        }

        .filters-container {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            overflow-x: auto; /* Allow horizontal scroll on small screens */
            padding-bottom: 2px; /* Space for scrollbar */
            scrollbar-width: none; /* Firefox */
        }
        .filters-container::-webkit-scrollbar { display: none; } /* Chrome/Safari */

        .filter-group {
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            color: var(--text-color);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.763L10.825 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .amount-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-color);
            white-space: nowrap;
        }

        .amount-btn:hover, .amount-btn.active {
            background: var(--highlight-bg);
            border-color: var(--accent-color);
        }

        .amount-popup {
            position: absolute;
            top: 100%;
            right: 0; /* Align to right */
            margin-top: 10px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            width: 300px;
            z-index: 100;
            display: none;
        }

        .amount-popup.active {
            display: block;
        }

        .slider-container {
            margin-top: 25px;
            margin-bottom: 10px;
            padding: 0 10px;
        }

        .amount-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: var(--muted-text);
        }

        .amount-display {
            cursor: text;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .amount-display:hover {
            background: var(--highlight-bg);
            border-color: #ddd;
        }

        .amount-editable-input {
            width: 80px;
            padding: 2px 6px;
            font-size: 1em;
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            outline: none;
        }

        /* noUiSlider Customization */
        .noUi-connect {
            background: var(--accent-color);
        }
        .noUi-horizontal {
            height: 6px;
        }
        .noUi-horizontal .noUi-handle {
            width: 18px;
            height: 18px;
            right: -9px;
            top: -7px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: grab;
        }
        .noUi-handle:before, .noUi-handle:after {
            display: none;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .filters-container {
                flex-wrap: wrap;
                overflow-x: visible;
            }
            .filter-group {
                flex: 1 1 calc(50% - 5px);
                min-width: auto;
            }
            .search-input-wrapper.active {
                width: 100%;
            }
            .amount-popup {
                left: 0;
                right: 0;
                width: 100%;
            }
        }
        
        select option:disabled {
            color: #ccc;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed; /* Prevent jumping */
        }

        /* Column Widths */
        .col-entity { width: 25%; }
        .col-capital { width: 15%; }
        .col-industry { width: 15%; }
        .col-type { width: 12%; }
        .col-amount { width: 17%; }
        .col-date { width: 16%; }

        th {
            background-color: #f1f2f6;
            color: var(--heading-color);
            font-weight: 600;
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th.no-sort {
            cursor: default;
        }
        
        th.no-sort::after {
            content: '' !important;
            display: none !important;
        }
        
        th.no-sort:hover {
            background-color: #f1f2f6;
        }

        th:hover {
            background-color: #e2e6ea;
        }

        th::after {
            content: '‚Üï';
            font-size: 0.8em;
            margin-left: 5px;
            opacity: 0.3;
            display: inline-block;
            width: 10px;
        }

        th.sorted-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            word-wrap: break-word;
        }

        tr:hover {
            background-color: #fafafa;
        }

        /* Cell Styles */
        .entity-name {
            font-weight: 600;
            display: block;
            color: var(--heading-color);
        }

        .entity-en {
            color: var(--muted-text);
            font-size: 0.85em;
            display: block;
        }

        .source-link {
            font-size: 0.8em;
            color: var(--muted-text);
            text-decoration: none;
            display: inline-block;
            margin-top: 4px;
            border-bottom: 1px dotted var(--muted-text);
        }

        .source-link:hover {
            color: var(--accent-color);
            border-bottom-style: solid;
        }
        
        .receiver-text {
            font-size: 0.8em;
            color: var(--muted-text);
            display: block;
            margin-top: 4px;
        }
        
        .note-icon {
            color: var(--accent-color);
            margin-left: 5px;
            cursor: help;
            text-decoration: none;
            font-size: 0.9em;
        }

        .amount {
            font-family: inherit; /* Match body font */
            font-weight: 700;
            color: var(--heading-color);
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            background: var(--badge-bg);
            color: var(--badge-text);
            white-space: nowrap;
            margin-bottom: 2px;
        }

        /* Type Colors - keeping pastel but black text */
        .tag[data-type="Enterprise"], .tag[data-type="‰ºÅÊ•≠"] { background: var(--color-corp); color: var(--text-contrast); }
        .tag[data-type="Individual"], .tag[data-type="ÂÄã‰∫∫"] { background: var(--color-indv); color: var(--text-contrast); }
        .tag[data-type="Organization"], .tag[data-type="Ê©üÊßã"] { background: var(--color-org); color: var(--text-contrast); }
        .tag[data-type="Celebrity"], .tag[data-type="Ëóù‰∫∫"] { background: var(--color-celeb); color: var(--text-contrast); }

        /* Footer */
        footer {
            margin-top: 40px;
            text-align: center;
            color: var(--muted-text);
            font-size: 0.9em;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .disclaimer {
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .verification-icon {
            color: #b2bec3;
            text-decoration: none;
            margin-left: 6px;
            font-size: 0.9em;
            transition: color 0.2s;
        }
        
        .verification-icon:hover {
            color: var(--accent-color);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
            }
            
            select {
                width: 100%;
            }
            
            .header-badges {
                justify-content: center;
            }
            
            /* Horizontal scroll hint */
            .table-container::after {
                content: '‚Üí';
                position: absolute;
                right: 10px;
                top: 50%;
                color: #ccc;
                pointer-events: none;
                display: none; /* Only show if overflowing */
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Chinese Artists Donations</h1>
            <div class="header-badges">
                <a href="https://github.com/Taipo-Big-Donations-Watcher/Taipo-Big-Donations-Watcher.github.io" target="_blank" class="badge">
                    <span class="badge-label">GitHub</span>
                    <span class="badge-value">Source</span>
                </a>
                <a href="https://docs.google.com/spreadsheets/d/1Bi2WDSCOLrxYh2E46ZDfpGMSfWyYWC0slThLGF3Dg-k/edit" target="_blank" class="badge">
                    <span class="badge-label">Raw Data</span>
                    <span class="badge-value green">Google Sheets</span>
                </a>
            </div>
        </div>
        
        <button class="burger-menu" id="burger-menu" aria-label="Toggle navigation">‚ò∞</button>
        
        <nav class="nav-menu" id="nav-menu">
            <a href="https://taipo-big-donations-watcher.github.io/en/" class="nav-link">Home</a>
            <a href="https://taipo-big-donations-watcher.github.io/en/about/" class="nav-link">About</a>
            <a href="https://taipo-redirect.com/" target="_blank" class="nav-link">Helpful Links</a>
            <a href="../../zh/chinese-artists/index.html" class="lang-switch">‰∏≠Êñá</a>
        </nav>
    </header>
    
    <div class="intro">
        <p class="intro-subtitle">On 26 November 2025, a large fire broke out at the Wang Fuk Court apartment complex in Tai Po District, New Territories, Hong Kong. There have been at least 156 deaths with 79 injured. One firefighter was killed. In response, organizations, companies, and individuals have pledged to donate for the fire relief efforts. This website attempts to track all public donations larger than HK$100,000.</p>
        <hr>
        <h2 class="summary-text" id="dynamic-summary"></h2>
    </div>

    <div class="controls">
        <!-- Search Button & Expandable Input -->
        <div class="search-container">
            <button id="search-btn" class="search-btn" aria-label="Search">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <div id="search-wrapper" class="search-input-wrapper">
                <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="search-input" class="search-input" placeholder="Search entities...">
            </div>
        </div>

        <!-- Filters Scrollable Row -->
        <div class="filters-container">
            <div class="filter-group">
                <select id="filter-capital" class="filter-select">
                    <option value="">All Origins</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-industry" class="filter-select">
                    <option value="">All Industries</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-type" class="filter-select">
                    <option value="">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-donation-type" class="filter-select">
                    <option value="">All Donations</option>
                    <option value="cash">üíµ Cash Only</option>
                    <option value="goods">üì¶ Goods Only</option>
                </select>
            </div>
            <div class="filter-group">
                <select id="filter-verification" class="filter-select">
                    <option value="">All Status</option>
                    <option value="verified">‚úì Verified</option>
                    <option value="unverified">‚è≥ Unverified</option>
                </select>
            </div>
        </div>

        <!-- Amount Filter Button & Popup -->
        <div class="filter-group" style="position: relative; min-width: auto;">
            <button id="amount-btn" class="amount-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                <span>Amount</span>
            </button>
            <div id="amount-popup" class="amount-popup">
                <div class="amount-inputs">
                    <span id="amount-min-display" class="amount-display">$0</span>
                    <span id="amount-max-display" class="amount-display">$10M+</span>
                </div>
                <div id="amount-slider" class="slider-container"></div>
                <!-- Hidden inputs for compatibility with existing logic -->
                <input type="hidden" id="filter-min-amount">
                <input type="hidden" id="filter-max-amount">
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="donation-table">
            <colgroup>
                <col class="col-entity">
                <col class="col-capital">
                <col class="col-industry">
                <col class="col-type">
                <col class="col-amount">
                <col class="col-date">
            </colgroup>
            <thead>
                <tr>
                    <th class="no-sort">Donor</th>
                    <th data-sort="capital">Origin</th>
                    <th data-sort="industry">Industry</th>
                    <th data-sort="type">Type</th>
                    <th data-sort="amountRaw" id="amount-header">Amount (HKD)</th>
                    <th data-sort="date">Date</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Rows will be populated by JS -->
            </tbody>
        </table>
    </div>
    
    <div id="no-results" style="text-align:center; padding: 40px; display: none; color: #666;">
        No matching donations found.
    </div>

    <footer>
        <p class="disclaimer">Data sourced from public announcements. <a href="https://t.me/ayip002" target="_blank" style="color:inherit">Corrections welcome.</a></p>
        <p>Last Updated: <span id="build-time">2025-12-03T00:26:05.738Z</span></p>
        <p style="margin-top:10px">Made by <a href="https://www.threads.com/@angusflies" target="_blank" style="color:inherit">@angusflies</a></p>
    </footer>

    <!-- Data Injection -->
    <script type="application/json" id="donation-data">
[
  {
    "entity": "Âäâ‰∫¶Ëè≤",
    "entityEn": "",
    "group": "",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$1,650,000",
    "amountRaw": 1650000,
    "cashAmount": "$1,650,000",
    "cashAmountRaw": 1650000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "",
    "through": "Red Cross Society of China",
    "primarySource": "https://www.redcross.org.cn/html/2025-12/112103.html",
    "secondarySource": "",
    "verificationLink": "https://www.redcross.org.cn/html/2025-12/112103.html",
    "date": "",
    "entityDisplay": "Âäâ‰∫¶Ëè≤",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$1,650,000"
  },
  {
    "entity": "Âë®Ê∑±",
    "entityEn": "Zhou Shen",
    "group": "‰∏≠ÂúãËóù‰∫∫",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$1,100,000",
    "amountRaw": 1100000,
    "cashAmount": "$1,100,000",
    "cashAmountRaw": 1100000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "1ÁôæËê¨RMB",
    "through": "‰∏äÊµ∑Âæ©ÊòüÂÖ¨ÁõäÂü∫ÈáëÊúÉ",
    "primarySource": "https://weibo.com/7747325954/QfNQn5mQz",
    "secondarySource": "",
    "verificationLink": "https://weibo.com/7747325954/QfNQn5mQz",
    "date": "28/11/2025",
    "entityDisplay": "Zhou Shen",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$1,100,000"
  },
  {
    "entity": "Âê¥ÂÆ£ÂÑÄ_Betty",
    "entityEn": "",
    "group": "‰∏≠ÂúãËóù‰∫∫",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$660,000",
    "amountRaw": 660000,
    "cashAmount": "$660,000",
    "cashAmountRaw": 660000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "60Ëê¨ÂÖÉ‰∫∫Ê∞ëÂπ£",
    "through": "‰∏äÊµ∑Âæ©ÊòüÂÖ¨ÁõäÂü∫ÈáëÊúÉ",
    "primarySource": "https://weibo.com/7747325954/QfXeqnb8L",
    "secondarySource": "",
    "verificationLink": "https://weibo.com/7747325954/QfXeqnb8L",
    "date": "",
    "entityDisplay": "Âê¥ÂÆ£ÂÑÄ_Betty",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$660,000"
  },
  {
    "entity": "Á´†Ëã•Ê•†",
    "entityEn": "",
    "group": "‰∏≠ÂúãËóù‰∫∫",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$550,000",
    "amountRaw": 550000,
    "cashAmount": "$550,000",
    "cashAmountRaw": 550000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "50Ëê¨ÂÖÉ‰∫∫Ê∞ëÂπ£",
    "through": "‰∏äÊµ∑Âæ©ÊòüÂÖ¨ÁõäÂü∫ÈáëÊúÉ",
    "primarySource": "https://weibo.com/7747325954/Qg6eno25w",
    "secondarySource": "",
    "verificationLink": "https://weibo.com/7747325954/Qg6eno25w",
    "date": "29/11/2025",
    "entityDisplay": "Á´†Ëã•Ê•†",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$550,000"
  },
  {
    "entity": "Â∞èÊûóÊòØÊùéÊòÄÈã≠",
    "entityEn": "",
    "group": "‰∏≠ÂúãËóù‰∫∫",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$550,000",
    "amountRaw": 550000,
    "cashAmount": "$550,000",
    "cashAmountRaw": 550000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "50Ëê¨ÂÖÉ‰∫∫Ê∞ëÂπ£",
    "through": "‰∏äÊµ∑Âæ©ÊòüÂÖ¨ÁõäÂü∫ÈáëÊúÉ",
    "primarySource": "https://weibo.com/7747325954/QfY7AFbmt",
    "secondarySource": "",
    "verificationLink": "https://weibo.com/7747325954/QfY7AFbmt",
    "date": "28/11/2025",
    "entityDisplay": "Â∞èÊûóÊòØÊùéÊòÄÈã≠",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$550,000"
  },
  {
    "entity": "Â±ïËªí",
    "entityEn": "",
    "group": "‰∏≠ÂúãËóù‰∫∫",
    "capital": "‰∏≠Âúã",
    "industry": "Â®õÊ®Ç",
    "type": "Ëóù‰∫∫",
    "amount": "$330,000",
    "amountRaw": 330000,
    "cashAmount": "$330,000",
    "cashAmountRaw": 330000,
    "goodsAmount": "$0",
    "goodsAmountRaw": 0,
    "note": "30Ëê¨ÂÖÉ‰∫∫Ê∞ëÂπ£",
    "through": "‰∏äÊµ∑Âæ©ÊòüÂÖ¨ÁõäÂü∫ÈáëÊúÉ",
    "primarySource": "https://weibo.com/7747325954/Qg7D0FcgW",
    "secondarySource": "",
    "verificationLink": "https://weibo.com/7747325954/Qg7D0FcgW",
    "date": "29/11/2025",
    "entityDisplay": "Â±ïËªí",
    "capitalDisplay": "China",
    "industryDisplay": "Entertainment",
    "industryIcon": "üé¨",
    "typeDisplay": "Celebrity",
    "amountDisplay": "$330,000"
  }
]
    </script>

    <script type="application/json" id="page-meta">
        {"lang": "en", "buildTime": "2025-12-03T00:26:05.738Z"}
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State
            let allDonations = [];
            let currentDonations = [];
            let lang = 'en';
            let sortField = 'amountRaw';
            let sortDir = 'desc';
            
            // Burger Menu Toggle
            const burgerMenu = document.getElementById('burger-menu');
            const navMenu = document.getElementById('nav-menu');
            
            if (burgerMenu && navMenu) {
                burgerMenu.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
            }

            // Flags Mapping
            const FLAGS = {
                'Hong Kong': 'üá≠üá∞', 'È¶ôÊ∏Ø': 'üá≠üá∞',
                'China': 'üá®üá≥', '‰∏≠Âúã': 'üá®üá≥',
                'USA': 'üá∫üá∏', 'ÁæéÂúã': 'üá∫üá∏',
                'UK': 'üá¨üáß', 'Ëã±Âúã': 'üá¨üáß',
                'Japan': 'üáØüáµ', 'Êó•Êú¨': 'üáØüáµ',
                'South Korea': 'üá∞üá∑', 'ÈüìÂúã': 'üá∞üá∑',
                'Macau': 'üá≤üá¥', 'Êæ≥ÈñÄ': 'üá≤üá¥',
                'Taiwan': 'üáπüáº', 'Âè∞ÁÅ£': 'üáπüáº',
                'Malaysia': 'üá≤üáæ', 'È¶¨‰æÜË•ø‰∫û': 'üá≤üáæ',
                'Singapore': 'üá∏üá¨', 'Êñ∞Âä†Âù°': 'üá∏üá¨',
                'Canada': 'üá®üá¶', 'Âä†ÊãøÂ§ß': 'üá®üá¶',
                'France': 'üá´üá∑', 'Ê≥ïÂúã': 'üá´üá∑',
                'Netherlands': 'üá≥üá±', 'Ëç∑Ëò≠': 'üá≥üá±',
                'Switzerland': 'üá®üá≠', 'ÁëûÂ£´': 'üá®üá≠',
                'International': 'üåê', 'ÂúãÈöõ': 'üåê'
            };
            
            // Fallback Emoji Mapping (if missing from build)
            const INDUSTRY_ICONS = {
                'Finance': 'üí∞', 'ÈáëËûç': 'üí∞',
                'Technology': 'üíª', 'ÁßëÊäÄ': 'üíª',
                'Real Estate': 'üè¢', 'ÊàøÂú∞Áî¢': 'üè¢',
                'Entertainment': 'üé¨', 'Â®õÊ®Ç': 'üé¨',
                'Food & Beverage': 'üçî', 'È£üÂìÅÈ£≤Êñô': 'üçî',
                'Retail': 'üè™', 'Èõ∂ÂîÆ': 'üè™'
            };
            
            // Origin Adjectives (for dynamic summary)
            const ORIGIN_ADJ = {
                en: {
                    'Hong Kong': 'Hong Kong', 'È¶ôÊ∏Ø': 'Hong Kong',
                    'China': 'Chinese', '‰∏≠Âúã': 'Chinese',
                    'USA': 'American', 'ÁæéÂúã': 'American',
                    'UK': 'British', 'Ëã±Âúã': 'British',
                    'South Korea': 'Korean', 'ÈüìÂúã': 'Korean',
                    'Japan': 'Japanese', 'Êó•Êú¨': 'Japanese',
                    'Macau': 'Macau', 'Êæ≥ÈñÄ': 'Macau',
                    'Taiwan': 'Taiwanese', 'Âè∞ÁÅ£': 'Taiwanese',
                    'Malaysia': 'Malaysian', 'È¶¨‰æÜË•ø‰∫û': 'Malaysian',
                    'Singapore': 'Singaporean', 'Êñ∞Âä†Âù°': 'Singaporean',
                    'Canada': 'Canadian', 'Âä†ÊãøÂ§ß': 'Canadian',
                    'France': 'French', 'Ê≥ïÂúã': 'French',
                    'Netherlands': 'Dutch', 'Ëç∑Ëò≠': 'Dutch',
                    'Switzerland': 'Swiss', 'ÁëûÂ£´': 'Swiss',
                    'International': 'International', 'ÂúãÈöõ': 'International'
                },
                zh: {
                    'Hong Kong': 'È¶ôÊ∏Ø', 'È¶ôÊ∏Ø': 'È¶ôÊ∏Ø',
                    'China': '‰∏≠Âúã', '‰∏≠Âúã': '‰∏≠Âúã',
                    'USA': 'ÁæéÂúã', 'ÁæéÂúã': 'ÁæéÂúã',
                    'UK': 'Ëã±Âúã', 'Ëã±Âúã': 'Ëã±Âúã',
                    'South Korea': 'ÈüìÂúã', 'ÈüìÂúã': 'ÈüìÂúã',
                    'Japan': 'Êó•Êú¨', 'Êó•Êú¨': 'Êó•Êú¨',
                    'Macau': 'Êæ≥ÈñÄ', 'Êæ≥ÈñÄ': 'Êæ≥ÈñÄ',
                    'Taiwan': 'Âè∞ÁÅ£', 'Âè∞ÁÅ£': 'Âè∞ÁÅ£',
                    'Malaysia': 'È¶¨‰æÜË•ø‰∫û', 'È¶¨‰æÜË•ø‰∫û': 'È¶¨‰æÜË•ø‰∫û',
                    'Singapore': 'Êñ∞Âä†Âù°', 'Êñ∞Âä†Âù°': 'Êñ∞Âä†Âù°',
                    'Canada': 'Âä†ÊãøÂ§ß', 'Âä†ÊãøÂ§ß': 'Âä†ÊãøÂ§ß',
                    'France': 'Ê≥ïÂúã', 'Ê≥ïÂúã': 'Ê≥ïÂúã',
                    'Netherlands': 'Ëç∑Ëò≠', 'Ëç∑Ëò≠': 'Ëç∑Ëò≠',
                    'Switzerland': 'ÁëûÂ£´', 'ÁëûÂ£´': 'ÁëûÂ£´',
                    'International': 'ÂúãÈöõ', 'ÂúãÈöõ': 'ÂúãÈöõ'
                }
            };
            
            // Type to Entity Word with classifier info for Chinese
            // classifier: ‰Ωç for people (ÊçêÊ¨æËÄÖ, Ëóù‰∫∫), ÂÄã for organizations/groups (Á§æÂúò, Ê©üÊßã, ‰ºÅÊ•≠)
            // suffix: ÂúòÈ´î for ÂÄã‰∫∫ and ÊîøÂ∫ú
            const TYPE_ENTITY = {
                en: {
                    'Enterprise': 'companies', '‰ºÅÊ•≠': 'companies',
                    'Organization': 'organizations', 'Ê©üÊßã': 'organizations',
                    'Individual': 'individuals', 'ÂÄã‰∫∫': 'individuals',
                    'Celebrity': 'celebrities', 'Ëóù‰∫∫': 'celebrities',
                    'Association': 'associations', 'Á§æÂúò': 'associations',
                    'Government': 'government bodies', 'ÊîøÂ∫ú': 'government bodies',
                    'Foundation': 'foundations', 'Âü∫Èáë': 'foundations',
                    '_default': 'entities'
                },
                zh: {
                    'Enterprise': { word: '‰ºÅÊ•≠', classifier: 'Èñì' },
                    '‰ºÅÊ•≠': { word: '‰ºÅÊ•≠', classifier: 'Èñì' },
                    'Organization': { word: 'Ê©üÊßã', classifier: 'ÂÄã' },
                    'Ê©üÊßã': { word: 'Ê©üÊßã', classifier: 'ÂÄã' },
                    'Individual': { word: 'ÂÄã‰∫∫ÂúòÈ´î', classifier: 'ÂÄã' },
                    'ÂÄã‰∫∫': { word: 'ÂÄã‰∫∫ÂúòÈ´î', classifier: 'ÂÄã' },
                    'Celebrity': { word: 'Ëóù‰∫∫', classifier: '‰Ωç' },
                    'Ëóù‰∫∫': { word: 'Ëóù‰∫∫', classifier: '‰Ωç' },
                    'Association': { word: 'Á§æÂúò', classifier: 'ÂÄã' },
                    'Á§æÂúò': { word: 'Á§æÂúò', classifier: 'ÂÄã' },
                    'Government': { word: 'ÊîøÂ∫úÂúòÈ´î', classifier: 'ÂÄã' },
                    'ÊîøÂ∫ú': { word: 'ÊîøÂ∫úÂúòÈ´î', classifier: 'ÂÄã' },
                    'Foundation': { word: 'Âü∫Èáë', classifier: 'ÂÄã' },
                    'Âü∫Èáë': { word: 'Âü∫Èáë', classifier: 'ÂÄã' },
                    '_default': { word: 'ÊçêÊ¨æËÄÖ', classifier: '‰Ωç' }
                }
            };

            // DOM Elements
            const tableBody = document.getElementById('table-body');
            const searchInput = document.getElementById('search-input');
            const filterCapital = document.getElementById('filter-capital');
            const filterIndustry = document.getElementById('filter-industry');
            const filterType = document.getElementById('filter-type');
            const filterDonationType = document.getElementById('filter-donation-type');
            const filterVerification = document.getElementById('filter-verification');
            const filterMinAmount = document.getElementById('filter-min-amount');
            const filterMaxAmount = document.getElementById('filter-max-amount');
            const amountHeader = document.getElementById('amount-header');
            const noResults = document.getElementById('no-results');
            const dynamicSummary = document.getElementById('dynamic-summary');
            
            // Store original filter options for reference
            let filterOptions = {
                capital: [],
                industry: [],
                type: []
            };
            
            // i18n labels for amount header
            const AMOUNT_LABELS = {
                en: { default: 'Amount (HKD)', cash: 'Cash (HKD)', goods: 'Goods (HKD)' },
                zh: { default: 'ÈáëÈ°ç (Ê∏ØÂπ£)', cash: 'ÁèæÈáë (Ê∏ØÂπ£)', goods: 'Áâ©Ë≥á (Ê∏ØÂπ£)' }
            };
            
            try {
                const dataElement = document.getElementById('donation-data');
                const metaElement = document.getElementById('page-meta');
                
                if (dataElement && dataElement.textContent.trim()) {
                    allDonations = JSON.parse(dataElement.textContent);
                    // Initialize currentDonations with all data
                    currentDonations = [...allDonations];
                    
                    const meta = JSON.parse(metaElement.textContent);
                    lang = meta.lang || 'en';
                    
                    // Initial Setup
                    formatBuildTime();
                    initFilters();
                    initUIControls(); // New UI logic
                    initAmountSlider(); // New Slider logic
                    readUrlParams(); // This will filter/sort and render
                    
                    // Event Listeners
                    searchInput.addEventListener('input', handleSearch);
                    filterCapital.addEventListener('change', handleFilter);
                    filterIndustry.addEventListener('change', handleFilter);
                    filterType.addEventListener('change', handleFilter);
                    filterDonationType.addEventListener('change', handleFilter);
                    filterVerification.addEventListener('change', handleFilter);
                    // Removed direct amount input listeners, handled by slider
                    
                    document.querySelectorAll('th[data-sort]').forEach(th => {
                        th.addEventListener('click', () => handleSort(th.dataset.sort));
                    });
                }
            } catch (e) {
                console.error('Error initializing:', e);
            }

            function formatBuildTime() {
                const dateStr = document.getElementById('build-time').textContent;
                document.getElementById('build-time').textContent = new Date(dateStr).toLocaleString(
                    lang === 'zh' ? 'zh-HK' : 'en-US',
                    { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }
                );
            }
            
            function updateDynamicSummary() {
                const donationType = filterDonationType.value;
                const verificationFilter = filterVerification.value;
                
                // Get filter values (excluding verification)
                const capitalFilter = filterCapital.value;
                const industryFilter = filterIndustry.value;
                const typeFilter = filterType.value;
                const minAmount = filterMinAmount.value ? parseFloat(filterMinAmount.value) : null;
                const maxAmount = filterMaxAmount.value ? parseFloat(filterMaxAmount.value) : null;
                const query = searchInput.value.toLowerCase();
                
                // Helper to get amount based on donation type
                const getAmount = (d) => {
                    if (donationType === 'cash') return d.cashAmountRaw || 0;
                    if (donationType === 'goods') return d.goodsAmountRaw || 0;
                    return d.amountRaw || 0;
                };
                
                // Helper to check if donation is verified
                const isVerified = (d) => d.verificationLink && d.verificationLink.trim() !== '';
                
                // Filter donations WITHOUT verification filter (for total in first sentence)
                const baseFilteredDonations = allDonations.filter(d => {
                    // Search
                    if (query) {
                        const text = [d.entity, d.entityDisplay, d.entityEn, d.industryDisplay, d.capitalDisplay].join(' ').toLowerCase();
                        if (!text.includes(query)) return false;
                    }
                    // Filters
                    if (capitalFilter && (d.capitalDisplay || d.capital) !== capitalFilter) return false;
                    if (industryFilter && (d.industryDisplay || d.industry) !== industryFilter) return false;
                    if (typeFilter && (d.typeDisplay || d.type) !== typeFilter) return false;
                    // Donation Type
                    let amountToCheck = getAmount(d);
                    if (donationType === 'cash' && (d.cashAmountRaw === null || d.cashAmountRaw === 0)) return false;
                    if (donationType === 'goods' && (d.goodsAmountRaw === null || d.goodsAmountRaw === 0)) return false;
                    // Min/Max
                    if (minAmount !== null && (amountToCheck === null || amountToCheck < minAmount)) return false;
                    if (maxAmount !== null && (amountToCheck === null || amountToCheck > maxAmount)) return false;
                    return true;
                });
                
                // Calculate total amount (regardless of verification)
                let totalAmount = 0;
                let totalCount = baseFilteredDonations.length;
                baseFilteredDonations.forEach(d => { totalAmount += getAmount(d); });
                
                // Calculate verified and unverified amounts
                let verifiedAmount = 0;
                let unverifiedAmount = 0;
                baseFilteredDonations.forEach(d => {
                    const amt = getAmount(d);
                    if (isVerified(d)) {
                        verifiedAmount += amt;
                    } else {
                        unverifiedAmount += amt;
                    }
                });
                
                const amountStr = '$' + totalAmount.toLocaleString();
                const verifiedAmountStr = '$' + verifiedAmount.toLocaleString();
                const unverifiedAmountStr = '$' + unverifiedAmount.toLocaleString();
                
                // Build entity word based on type
                let entityWord, classifier;
                if (lang === 'zh') {
                    const entityInfo = typeFilter 
                        ? (TYPE_ENTITY.zh[typeFilter] || TYPE_ENTITY.zh['_default'])
                        : TYPE_ENTITY.zh['_default'];
                    entityWord = entityInfo.word;
                    classifier = entityInfo.classifier;
                } else {
                    entityWord = typeFilter 
                        ? (TYPE_ENTITY.en[typeFilter] || TYPE_ENTITY.en['_default'])
                        : TYPE_ENTITY.en['_default'];
                }
                
                // Build origin adjective
                let originAdj = '';
                if (capitalFilter) {
                    originAdj = ORIGIN_ADJ[lang][capitalFilter] || capitalFilter;
                }
                
                // Build industry suffix
                let industrySuffix = '';
                if (industryFilter) {
                    if (lang === 'zh') {
                        industrySuffix = industryFilter + 'Ë°åÊ•≠';
                    } else {
                        industrySuffix = 'in ' + industryFilter;
                    }
                }
                
                // Build donation type suffix
                let donationTypeSuffix = '';
                if (donationType === 'cash') {
                    donationTypeSuffix = lang === 'zh' ? 'ÁèæÈáë' : ' in cash';
                } else if (donationType === 'goods') {
                    donationTypeSuffix = lang === 'zh' ? 'Áâ©Ë≥áÂèäÊúçÂãô' : ' in value of goods and services provided';
                }
                
                // Update amount header
                if (donationType === 'cash') {
                    amountHeader.textContent = AMOUNT_LABELS[lang].cash;
                } else if (donationType === 'goods') {
                    amountHeader.textContent = AMOUNT_LABELS[lang].goods;
                } else {
                    amountHeader.textContent = AMOUNT_LABELS[lang].default;
                }
                
                // Get today's date
                const today = new Date().toLocaleDateString(
                    lang === 'zh' ? 'zh-HK' : 'en-US',
                    { year: 'numeric', month: 'long', day: 'numeric' }
                );
                
                // Construct first sentence (total, regardless of verification filter)
                let summary;
                if (lang === 'zh') {
                    const entityPhrase = originAdj ? `${originAdj}${entityWord}` : entityWord;
                    summary = `Êà™Ëá≥ ${today}Ôºå<strong>${totalCount}</strong>${classifier}${entityPhrase}${industrySuffix ? ' (' + industrySuffix + ')' : ''} Â∑≤ÊâøË´æÊçêÂá∫ <strong>${amountStr}</strong>${donationTypeSuffix} ÊîØÊè¥ÁÅ´ÁÅΩÊïëÊè¥„ÄÇ`;
                } else {
                    const entityPhrase = originAdj ? `${originAdj} ${entityWord}` : entityWord;
                    summary = `As of ${today}, <strong>${totalCount}</strong> ${entityPhrase}${industrySuffix ? ' ' + industrySuffix : ''} have pledged to donate <strong>${amountStr}</strong>${donationTypeSuffix} for the fire relief efforts.`;
                }
                
                // Add second sentence for verification status
                if (verificationFilter === 'verified') {
                    if (lang === 'zh') {
                        summary += ` ÂÖ∂‰∏≠ÔºåÂè™Êúâ <strong>${verifiedAmountStr}</strong> Â∑≤Ê†∏ÂØ¶Âà∞Â∏≥„ÄÇ`;
                    } else {
                        summary += ` Of which, only <strong>${verifiedAmountStr}</strong> has been verified.`;
                    }
                } else if (verificationFilter === 'unverified') {
                    if (lang === 'zh') {
                        summary += ` ÂÖ∂‰∏≠Ôºå<strong>${unverifiedAmountStr}</strong> ‰ªçÊú™Ê†∏ÂØ¶Âà∞Â∏≥„ÄÇ`;
                    } else {
                        summary += ` Of which, <strong>${unverifiedAmountStr}</strong> is still unaccounted for.`;
                    }
                }
                
                dynamicSummary.innerHTML = summary;
            }

            function getIcon(type, value) {
                if (!value) return '';
                if (type === 'capital') {
                    return FLAGS[value] || '';
                }
                if (type === 'industry') {
                    // Try to get icon from donation object logic first (passed in data)
                    // But we need to check map for dropdown population
                    return INDUSTRY_ICONS[value] || '';
                }
                return '';
            }
            
            function initUIControls() {
                // Search Toggle
                const searchBtn = document.getElementById('search-btn');
                const searchWrapper = document.getElementById('search-wrapper');
                const searchInput = document.getElementById('search-input');
                
                if (searchBtn && searchWrapper) {
                    searchBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        searchWrapper.classList.toggle('active');
                        searchBtn.classList.toggle('active');
                        if (searchWrapper.classList.contains('active')) {
                            searchInput.focus();
                        }
                    });
                    
                    // Close search when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!searchWrapper.contains(e.target) && !searchBtn.contains(e.target)) {
                            searchWrapper.classList.remove('active');
                            searchBtn.classList.remove('active');
                        }
                    });
                }
                
                // Amount Popup Toggle
                const amountBtn = document.getElementById('amount-btn');
                const amountPopup = document.getElementById('amount-popup');
                
                if (amountBtn && amountPopup) {
                    amountBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        amountPopup.classList.toggle('active');
                        amountBtn.classList.toggle('active');
                    });
                    
                    // Close popup when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!amountPopup.contains(e.target) && !amountBtn.contains(e.target)) {
                            amountPopup.classList.remove('active');
                            amountBtn.classList.remove('active');
                        }
                    });
                    
                    // Prevent closing when clicking inside popup
                    amountPopup.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }
            }

            function initAmountSlider() {
                const slider = document.getElementById('amount-slider');
                if (!slider) return;
                
                // Calculate global max amount
                let maxVal = 0;
                allDonations.forEach(d => {
                    const val = Math.max(d.amountRaw || 0, d.cashAmountRaw || 0, d.goodsAmountRaw || 0);
                    if (val > maxVal) maxVal = val;
                });
                
                if (maxVal === 0) maxVal = 1000000;
                if (maxVal > 1000000) {
                    maxVal = Math.ceil(maxVal / 1000000) * 1000000;
                }

                // Create non-linear scale (log-like)
                // Set 50% point to 1M if max is huge, or 10% of max
                const midPoint = Math.min(1000000, maxVal * 0.1);

                noUiSlider.create(slider, {
                    start: [0, maxVal],
                    connect: true,
                    range: {
                        'min': 0,
                        '50%': midPoint, // Log-like scale: 50% slider width = 1M (or 10% max)
                        'max': maxVal
                    },
                    step: 10000,
                    format: {
                        to: value => Math.round(value),
                        from: value => Number(value)
                    }
                });
                
                const minDisplay = document.getElementById('amount-min-display');
                const maxDisplay = document.getElementById('amount-max-display');
                const minInput = document.getElementById('filter-min-amount');
                const maxInput = document.getElementById('filter-max-amount');
                
                // Helper to format amount
                const formatAmount = (val) => {
                    if (val === 0) return '$0';
                    if (val >= 1000000) return '$' + (val/1000000).toFixed(1).replace('.0', '') + 'M';
                    if (val >= 1000) return '$' + (val/1000).toFixed(0) + 'k';
                    return '$' + val;
                };

                slider.noUiSlider.on('update', function (values, handle) {
                    const val = Math.round(values[handle]);
                    const el = handle === 0 ? minDisplay : maxDisplay;
                    const input = handle === 0 ? minInput : maxInput;
                    
                    // Only update text if not currently editing
                    if (!el.querySelector('input')) {
                        el.textContent = formatAmount(val);
                    }
                    input.value = val;
                });
                
                slider.noUiSlider.on('change', function () {
                    handleFilter();
                });

                // Click to edit logic
                [minDisplay, maxDisplay].forEach((el, index) => {
                    el.addEventListener('click', function() {
                        if (this.querySelector('input')) return; // Already editing
                        
                        const currentVal = index === 0 ? minInput.value : maxInput.value;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'amount-editable-input';
                        input.value = currentVal;
                        
                        this.innerHTML = '';
                        this.appendChild(input);
                        input.focus();
                        
                        const finishEdit = () => {
                            let val = parseFloat(input.value) || 0;
                            // Validation
                            if (val < 0) val = 0;
                            if (val > maxVal) val = maxVal;
                            
                            const values = slider.noUiSlider.get();
                            if (index === 0) values[0] = val;
                            else values[1] = val;
                            
                            slider.noUiSlider.set(values);
                            // Trigger filter immediately
                            handleFilter();
                            
                            // Text update will happen via slider update event
                        };
                        
                        input.addEventListener('blur', finishEdit);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                input.blur();
                            }
                        });
                    });
                });
            }

            function initFilters() {
                // Helper to count frequencies from all data
                const getCounts = (field, displayField) => {
                    const counts = {};
                    allDonations.forEach(d => {
                        const val = d[displayField] || d[field];
                        if (val) {
                            counts[val] = (counts[val] || 0) + 1;
                        }
                    });
                    return counts;
                };

                // Populate Capital (HK -> CN -> Freq)
                const capitalCounts = getCounts('capital', 'capitalDisplay');
                const capitals = Object.keys(capitalCounts).sort((a, b) => {
                    // Priority: HK, then China
                    const isHK_A = a.includes('Hong Kong') || a.includes('È¶ôÊ∏Ø');
                    const isHK_B = b.includes('Hong Kong') || b.includes('È¶ôÊ∏Ø');
                    if (isHK_A && !isHK_B) return -1;
                    if (!isHK_A && isHK_B) return 1;
                    
                    const isCN_A = a.includes('China') || a.includes('‰∏≠Âúã');
                    const isCN_B = b.includes('China') || b.includes('‰∏≠Âúã');
                    if (isCN_A && !isCN_B) return -1;
                    if (!isCN_A && isCN_B) return 1;
                    
                    // Then by frequency
                    return capitalCounts[b] - capitalCounts[a];
                });
                
                // Store options with metadata
                filterOptions.capital = capitals.map(val => ({
                    value: val,
                    icon: FLAGS[val] || '',
                    originalCount: capitalCounts[val]
                }));
                
                capitals.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.dataset.icon = FLAGS[val] || '';
                    option.textContent = `${FLAGS[val] || ''} ${val} (${capitalCounts[val]})`;
                    filterCapital.appendChild(option);
                });

                // Populate Industry (Freq)
                const industryCounts = getCounts('industry', 'industryDisplay');
                const industries = Object.keys(industryCounts).sort((a, b) => {
                    return industryCounts[b] - industryCounts[a];
                });
                
                // Find icon helper
                const findIcon = (val) => {
                    const ex = allDonations.find(d => (d.industryDisplay === val || d.industry === val));
                    return ex ? (ex.industryIcon || INDUSTRY_ICONS[val] || '') : '';
                };

                filterOptions.industry = industries.map(val => ({
                    value: val,
                    icon: findIcon(val),
                    originalCount: industryCounts[val]
                }));

                industries.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    const icon = findIcon(val);
                    option.dataset.icon = icon;
                    option.textContent = `${icon} ${val} (${industryCounts[val]})`;
                    filterIndustry.appendChild(option);
                });

                // Populate Type
                const typeCounts = getCounts('type', 'typeDisplay');
                const types = Object.keys(typeCounts).sort();
                
                filterOptions.type = types.map(val => ({
                    value: val,
                    icon: '',
                    originalCount: typeCounts[val]
                }));
                
                types.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = `${val} (${typeCounts[val]})`;
                    filterType.appendChild(option);
                });
            }
            
            function updateFilterCounts() {
                // Get current filter values
                const capitalVal = filterCapital.value;
                const industryVal = filterIndustry.value;
                const typeVal = filterType.value;
                const donationTypeVal = filterDonationType.value;
                const minAmount = filterMinAmount.value ? parseFloat(filterMinAmount.value) : null;
                const maxAmount = filterMaxAmount.value ? parseFloat(filterMaxAmount.value) : null;
                const query = searchInput.value.toLowerCase();
                
                // Helper to filter data with specific exclusions
                const getFilteredData = (excludeFilter) => {
                    return allDonations.filter(d => {
                        // Search
                        if (query) {
                            const text = [
                                d.entity, d.entityDisplay, d.entityEn,
                                d.industryDisplay, d.capitalDisplay
                            ].join(' ').toLowerCase();
                            if (!text.includes(query)) return false;
                        }
                        
                        // Filters (exclude the one we're calculating for)
                        if (excludeFilter !== 'capital' && capitalVal && (d.capitalDisplay || d.capital) !== capitalVal) return false;
                        if (excludeFilter !== 'industry' && industryVal && (d.industryDisplay || d.industry) !== industryVal) return false;
                        if (excludeFilter !== 'type' && typeVal && (d.typeDisplay || d.type) !== typeVal) return false;
                        
                        // Amount Logic
                        let amountToCheck;
                        if (donationTypeVal === 'cash') {
                            if (d.cashAmountRaw === null || d.cashAmountRaw === 0) return false;
                            amountToCheck = d.cashAmountRaw;
                        } else if (donationTypeVal === 'goods') {
                            if (d.goodsAmountRaw === null || d.goodsAmountRaw === 0) return false;
                            amountToCheck = d.goodsAmountRaw;
                        } else {
                            amountToCheck = d.amountRaw;
                        }
                        
                        if (minAmount !== null && (amountToCheck === null || amountToCheck < minAmount)) return false;
                        if (maxAmount !== null && (amountToCheck === null || amountToCheck > maxAmount)) return false;
                        
                        return true;
                    });
                };
                
                // Update Capital dropdown
                const capitalData = getFilteredData('capital');
                const capitalCounts = {};
                capitalData.forEach(d => {
                    const val = d.capitalDisplay || d.capital;
                    if (val) capitalCounts[val] = (capitalCounts[val] || 0) + 1;
                });
                
                Array.from(filterCapital.options).forEach(option => {
                    if (!option.value) return; // Skip "All" option
                    const count = capitalCounts[option.value] || 0;
                    const icon = option.dataset.icon || '';
                    option.textContent = `${icon} ${option.value} (${count})`;
                    option.disabled = count === 0;
                });
                
                // Update Industry dropdown
                const industryData = getFilteredData('industry');
                const industryCounts = {};
                industryData.forEach(d => {
                    const val = d.industryDisplay || d.industry;
                    if (val) industryCounts[val] = (industryCounts[val] || 0) + 1;
                });
                
                Array.from(filterIndustry.options).forEach(option => {
                    if (!option.value) return;
                    const count = industryCounts[option.value] || 0;
                    const icon = option.dataset.icon || '';
                    option.textContent = `${icon} ${option.value} (${count})`;
                    option.disabled = count === 0;
                });
                
                // Update Type dropdown
                const typeData = getFilteredData('type');
                const typeCounts = {};
                typeData.forEach(d => {
                    const val = d.typeDisplay || d.type;
                    if (val) typeCounts[val] = (typeCounts[val] || 0) + 1;
                });
                
                Array.from(filterType.options).forEach(option => {
                    if (!option.value) return;
                    const count = typeCounts[option.value] || 0;
                    option.textContent = `${option.value} (${count})`;
                    option.disabled = count === 0;
                });
            }

            function handleSearch() {
                filterData();
            }

            function handleFilter() {
                filterData();
            }

            function handleSort(field) {
                if (sortField === field) {
                    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDir = 'desc'; // Default to desc for most things
                    if (field === 'capital' || field === 'industry') {
                        sortDir = 'asc';
                    }
                }
                
                // Update UI headers
                document.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                    if (th.dataset.sort === field) {
                        th.classList.add(`sorted-${sortDir}`);
                    }
                });
                
                filterData();
            }

            function filterData() {
                const query = searchInput.value.toLowerCase();
                const capital = filterCapital.value;
                const industry = filterIndustry.value;
                const type = filterType.value;
                const donationType = filterDonationType.value;
                const verification = filterVerification.value;
                const minAmount = filterMinAmount.value ? parseFloat(filterMinAmount.value) : null;
                const maxAmount = filterMaxAmount.value ? parseFloat(filterMaxAmount.value) : null;
                
                currentDonations = allDonations.filter(d => {
                    // Search
                    if (query) {
                        const text = [
                            d.entity, 
                            d.entityDisplay, 
                            d.entityEn,
                            d.industryDisplay,
                            d.capitalDisplay
                        ].join(' ').toLowerCase();
                        if (!text.includes(query)) return false;
                    }
                    
                    // Filters
                    if (capital && (d.capitalDisplay || d.capital) !== capital) return false;
                    if (industry && (d.industryDisplay || d.industry) !== industry) return false;
                    if (type && (d.typeDisplay || d.type) !== type) return false;
                    
                    // Verification Filter
                    if (verification === 'verified') {
                        if (!d.verificationLink || d.verificationLink.trim() === '') return false;
                    } else if (verification === 'unverified') {
                        if (d.verificationLink && d.verificationLink.trim() !== '') return false;
                    }
                    
                    // Donation Type Logic
                    let amountToCheck;
                    if (donationType === 'cash') {
                        if (d.cashAmountRaw === null || d.cashAmountRaw === 0) return false;
                        amountToCheck = d.cashAmountRaw;
                    } else if (donationType === 'goods') {
                        if (d.goodsAmountRaw === null || d.goodsAmountRaw === 0) return false;
                        amountToCheck = d.goodsAmountRaw;
                    } else {
                        amountToCheck = d.amountRaw;
                    }
                    
                    // Min/Max Amount Filters
                    if (minAmount !== null && (amountToCheck === null || amountToCheck < minAmount)) return false;
                    if (maxAmount !== null && (amountToCheck === null || amountToCheck > maxAmount)) return false;
                    
                    return true;
                });
                
                sortData();
                updateUrl();
                updateFilterCounts();
                updateDynamicSummary();
                renderTable();
            }

            function sortData() {
                const donationType = filterDonationType.value;
                
                currentDonations.sort((a, b) => {
                    let aVal, bVal;
                    
                    // Handle different field types
                    if (sortField === 'amountRaw') {
                        // Use the appropriate amount based on donation type filter
                        if (donationType === 'cash') {
                            aVal = a.cashAmountRaw || 0;
                            bVal = b.cashAmountRaw || 0;
                        } else if (donationType === 'goods') {
                            aVal = a.goodsAmountRaw || 0;
                            bVal = b.goodsAmountRaw || 0;
                        } else {
                            aVal = a.amountRaw || 0;
                            bVal = b.amountRaw || 0;
                        }
                    } else if (sortField === 'date') {
                        aVal = a.date || '';
                        bVal = b.date || '';
                    } else {
                        // Text fields - use display value
                        const displayKey = sortField + 'Display';
                        aVal = (a[displayKey] || a[sortField] || '').toString();
                        bVal = (b[displayKey] || b[sortField] || '').toString();
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortDir === 'asc' 
                            ? aVal.localeCompare(bVal, lang === 'zh' ? 'zh-HK' : 'en')
                            : bVal.localeCompare(aVal, lang === 'zh' ? 'zh-HK' : 'en');
                    } else {
                        return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                });
            }

            function renderTable() {
                tableBody.innerHTML = '';
                
                if (currentDonations.length === 0) {
                    noResults.style.display = 'block';
                    return;
                }
                
                noResults.style.display = 'none';
                const donationType = filterDonationType.value;
                
                // Show ALL rows
                currentDonations.forEach(d => {
                    const tr = document.createElement('tr');
                    
                    let entityHtml = `<span class="entity-name">${d.entityDisplay || d.entity}`;
                    
                    // Note Tooltip (i)
                    if (d.note) {
                        entityHtml += `<span class="note-icon" title="${d.note}">‚ìò</span>`;
                    }
                    entityHtml += `</span>`;

                    // Source Link Logic
                    if (d.primarySource) {
                        entityHtml += `<a href="${d.primarySource}" target="_blank" class="source-link">Source</a>`;
                    } else if (d.secondarySource) {
                        entityHtml += `<a href="${d.secondarySource}" target="_blank" class="source-link">Source&sup2;</a>`;
                    }
                    
                    // Flags & Icons
                    const capitalVal = d.capitalDisplay || d.capital || '';
                    const capitalFlag = FLAGS[capitalVal] || '';
                    
                    const industryVal = d.industryDisplay || d.industry || '';
                    const industryIcon = d.industryIcon || INDUSTRY_ICONS[industryVal] || '';
                    
                    // Get the appropriate amount based on filter
                    let displayAmount, displayAmountRaw;
                    if (donationType === 'cash') {
                        displayAmountRaw = d.cashAmountRaw;
                        displayAmount = displayAmountRaw !== null ? '$' + displayAmountRaw.toLocaleString() : (lang === 'zh' ? 'Êú™Áü•' : 'unclear');
                    } else if (donationType === 'goods') {
                        displayAmountRaw = d.goodsAmountRaw;
                        displayAmount = displayAmountRaw !== null ? '$' + displayAmountRaw.toLocaleString() : (lang === 'zh' ? 'Êú™Áü•' : 'unclear');
                    } else {
                        displayAmount = d.amountDisplay || d.amount || '-';
                    }
                    
                    // Amount with verification icon
                    let amountHtml = displayAmount;
                    if (d.verificationLink) {
                        amountHtml += `<a href="${d.verificationLink}" target="_blank" class="verification-icon" title="Verified Payment">‚úì</a>`;
                    }
                    
                    // Add receiver if exists (just name)
                    if (d.through) {
                        amountHtml += `<span class="receiver-text">${d.through}</span>`;
                    }
                    
                    tr.innerHTML = `
                        <td>${entityHtml}</td>
                        <td><span class="tag" data-val="${capitalVal}">${capitalFlag} ${capitalVal || '-'}</span></td>
                        <td><span class="tag" >${industryIcon} ${industryVal || '-'}</span></td>
                        <td><span class="tag" data-type="${d.typeDisplay || d.type}">${d.typeDisplay || d.type || '-'}</span></td>
                        <td class="amount">${amountHtml}</td>
                        <td style="white-space:nowrap; font-size:0.9em; color:#666">${d.date || '-'}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            function updateUrl() {
                const params = new URLSearchParams();
                if (searchInput.value) params.set('q', searchInput.value);
                if (filterCapital.value) params.set('capital', filterCapital.value);
                if (filterIndustry.value) params.set('industry', filterIndustry.value);
                if (filterType.value) params.set('type', filterType.value);
                if (filterDonationType.value) params.set('donationType', filterDonationType.value);
                if (filterVerification.value) params.set('verification', filterVerification.value);
                if (filterMinAmount.value) params.set('min', filterMinAmount.value);
                if (filterMaxAmount.value) params.set('max', filterMaxAmount.value);
                
                // Only push state if changed to avoid spamming history
                const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.replaceState({}, '', newUrl);
            }

            function readUrlParams() {
                const params = new URLSearchParams(window.location.search);
                if (params.has('q')) searchInput.value = params.get('q');
                if (params.has('capital')) filterCapital.value = params.get('capital');
                if (params.has('industry')) filterIndustry.value = params.get('industry');
                if (params.has('type')) filterType.value = params.get('type');
                if (params.has('donationType')) filterDonationType.value = params.get('donationType');
                if (params.has('verification')) filterVerification.value = params.get('verification');
                if (params.has('min')) filterMinAmount.value = params.get('min');
                if (params.has('max')) filterMaxAmount.value = params.get('max');
                
                // Always filter data to ensure consistent state
                filterData();
            }
        });
    </script>
</body>
</html>
